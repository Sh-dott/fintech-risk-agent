<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Decision Engine - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            color: white;
            margin-bottom: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 15px 0;
        }

        .metric-label {
            color: #666;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-unit {
            color: #999;
            font-size: 0.8em;
            margin-left: 5px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-healthy {
            background: #d4edda;
            color: #155724;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: relative;
            height: 400px;
        }

        .form-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .result-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            display: none;
        }

        .result-container.show {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .decision-badge {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.2em;
            margin: 15px 0;
        }

        .decision-allow {
            background: #d4edda;
            color: #155724;
        }

        .decision-block {
            background: #f8d7da;
            color: #721c24;
        }

        .decision-review {
            background: #fff3cd;
            color: #856404;
        }

        .reason-codes {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .reason-codes h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .reason-tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin: 4px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #ddd;
        }

        .history-table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        .history-table tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-weight: 600;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .error.show {
            display: block;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Risk Decision Engine</h1>
            <p>Real-time Transaction Scoring & Fraud Detection</p>
        </header>

        <!-- Metrics Dashboard -->
        <div class="dashboard" id="metricsContainer">
            <div class="card">
                <div class="metric-label">API Status</div>
                <div class="status-badge status-healthy" id="statusBadge">HEALTHY</div>
                <div style="color: #666; margin-top: 10px; font-size: 0.9em;" id="uptimeInfo">Uptime: --</div>
            </div>
            <div class="card">
                <div class="metric-label">Total Transactions</div>
                <div class="metric-value" id="totalTransactions">0</div>
            </div>
            <div class="card">
                <div class="metric-label">Approval Rate</div>
                <div class="metric-value"><span id="approvalRate">0</span><span class="metric-unit">%</span></div>
            </div>
            <div class="card">
                <div class="metric-label">P95 Latency</div>
                <div class="metric-value"><span id="p95Latency">0</span><span class="metric-unit">ms</span></div>
            </div>
            <div class="card">
                <div class="metric-label">Avg Risk Score</div>
                <div class="metric-value" id="avgRiskScore">0.0</div>
            </div>
            <div class="card">
                <div class="metric-label">Block Rate</div>
                <div class="metric-value"><span id="blockRate">0</span><span class="metric-unit">%</span></div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-container">
                <canvas id="decisionChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="riskDistributionChart"></canvas>
            </div>
        </div>

        <!-- Score a Transaction -->
        <div class="form-container">
            <h2>Test Transaction Scoring</h2>
            <form id="scoreForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="txnId">Transaction ID</label>
                        <input type="text" id="txnId" placeholder="e.g., txn_001" required>
                    </div>
                    <div class="form-group">
                        <label for="amount">Amount (USD)</label>
                        <input type="number" id="amount" step="0.01" placeholder="e.g., 100.00" required>
                    </div>
                    <div class="form-group">
                        <label for="userId">User ID</label>
                        <input type="text" id="userId" placeholder="e.g., usr_123" required>
                    </div>
                    <div class="form-group">
                        <label for="merchantId">Merchant ID</label>
                        <input type="text" id="merchantId" placeholder="e.g., mch_456" required>
                    </div>
                    <div class="form-group">
                        <label for="deviceId">Device ID</label>
                        <input type="text" id="deviceId" placeholder="e.g., dev_abc" required>
                    </div>
                    <div class="form-group">
                        <label for="ipAddress">IP Address</label>
                        <input type="text" id="ipAddress" placeholder="e.g., 192.168.1.1" required>
                    </div>
                </div>
                <button type="submit">Score Transaction</button>
            </form>

            <div class="error" id="errorMessage"></div>
            <div class="result-container" id="resultContainer">
                <h3>Decision Result</h3>
                <div id="resultContent"></div>
            </div>
        </div>

        <!-- Transaction History -->
        <div class="form-container">
            <h2>Transaction History</h2>
            <table class="history-table" id="historyTable">
                <thead>
                    <tr>
                        <th>Transaction ID</th>
                        <th>Decision</th>
                        <th>Risk Score</th>
                        <th>User ID</th>
                        <th>Merchant ID</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <tr><td colspan="6" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        // Initialize charts
        let decisionChart, riskDistributionChart;

        async function initDashboard() {
            await updateMetrics();
            await updateHistory();
            updateChartsOnInterval();
            setInterval(updateMetrics, 5000);
            setInterval(updateHistory, 10000);
        }

        async function updateMetrics() {
            try {
                const response = await fetch(`${API_BASE}/analytics`);
                const data = await response.json();

                document.getElementById('totalTransactions').textContent = data.summary.total_transactions;
                document.getElementById('approvalRate').textContent = data.summary.approval_rate_percent;
                document.getElementById('blockRate').textContent = data.summary.block_rate_percent;
                document.getElementById('p95Latency').textContent = data.performance.p95_latency_ms;
                document.getElementById('avgRiskScore').textContent = data.performance.avg_risk_score;

                const uptime = Math.floor(data.performance.uptime_seconds);
                const minutes = Math.floor(uptime / 60);
                const seconds = uptime % 60;
                document.getElementById('uptimeInfo').textContent = `Uptime: ${minutes}m ${seconds}s`;

                updateDecisionChart(data.summary);
            } catch (error) {
                console.error('Error updating metrics:', error);
            }
        }

        function updateDecisionChart(data) {
            const ctx = document.getElementById('decisionChart').getContext('2d');
            if (decisionChart) {
                decisionChart.destroy();
            }
            decisionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Allowed', 'Blocked', 'Review'],
                    datasets: [{
                        data: [data.total_allowed, data.total_blocked, data.total_review],
                        backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
                        borderColor: ['#fff', '#fff', '#fff'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Decision Distribution'
                        }
                    }
                }
            });
        }

        function updateChartsOnInterval() {
            const ctx2 = document.getElementById('riskDistributionChart').getContext('2d');
            if (riskDistributionChart) {
                riskDistributionChart.destroy();
            }
            riskDistributionChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Low Risk', 'Medium Risk', 'High Risk'],
                    datasets: [{
                        label: 'Transaction Count',
                        data: [45, 28, 12],
                        backgroundColor: ['#d4edda', '#fff3cd', '#f8d7da'],
                        borderColor: ['#28a745', '#ffc107', '#dc3545'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true
                        },
                        title: {
                            display: true,
                            text: 'Risk Distribution'
                        }
                    }
                }
            });
        }

        async function updateHistory() {
            try {
                const response = await fetch(`${API_BASE}/history?limit=10`);
                const data = await response.json();

                const tbody = document.getElementById('historyBody');
                tbody.innerHTML = '';

                if (data.transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No transactions yet</td></tr>';
                    return;
                }

                data.transactions.reverse().forEach(txn => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><strong>${txn.transaction_id}</strong></td>
                        <td><span class="reason-tag">${txn.decision.toUpperCase()}</span></td>
                        <td>${txn.risk_score.toFixed(3)}</td>
                        <td>${txn.user_id}</td>
                        <td>${txn.merchant_id}</td>
                        <td>${new Date(txn.timestamp).toLocaleTimeString()}</td>
                    `;
                });
            } catch (error) {
                console.error('Error updating history:', error);
            }
        }

        document.getElementById('scoreForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const payload = {
                transaction_id: document.getElementById('txnId').value,
                amount: parseFloat(document.getElementById('amount').value),
                currency: 'USD',
                merchant_id: document.getElementById('merchantId').value,
                user_id: document.getElementById('userId').value,
                device_id: document.getElementById('deviceId').value,
                ip_address: document.getElementById('ipAddress').value,
                user_country: 'US'
            };

            try {
                document.getElementById('errorMessage').classList.remove('show');
                const response = await fetch(`${API_BASE}/score`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                displayResult(result);
                await updateMetrics();
                await updateHistory();
            } catch (error) {
                document.getElementById('errorMessage').textContent = `Error: ${error.message}`;
                document.getElementById('errorMessage').classList.add('show');
                console.error('Error scoring transaction:', error);
            }
        });

        function displayResult(result) {
            const decisionClass = `decision-${result.decision}`;
            const resultContent = `
                <div class="decision-badge ${decisionClass}">
                    ${result.decision.toUpperCase()}
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div>
                        <strong>Risk Score:</strong> ${result.risk_score.toFixed(3)}
                    </div>
                    <div>
                        <strong>Risk Level:</strong> ${result.risk_level.toUpperCase()}
                    </div>
                </div>
                <div class="reason-codes">
                    <h4>Reason Codes</h4>
                    ${result.reason_codes.map(code => `<span class="reason-tag">${code}</span>`).join('')}
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <strong>Explanation:</strong>
                    <p style="margin-top: 8px; color: #666;">${result.explanation}</p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; font-size: 0.9em; color: #666;">
                    <div>Latency: ${result.latency_ms.toFixed(2)}ms</div>
                    <div>Compliance ID: ${result.compliance_log_id}</div>
                </div>
            `;
            document.getElementById('resultContent').innerHTML = resultContent;
            document.getElementById('resultContainer').classList.add('show');
        }

        // Initialize on load
        window.addEventListener('load', initDashboard);
    </script>
</body>
</html>
